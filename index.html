<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>AR Camiseta</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />

<style>
html,body{margin:0;height:100%;background:#000;color:#fff;font-family:Arial}
#videoWrapper{position:fixed;inset:0;overflow:hidden}
#cam{width:100%;height:100%;object-fit:cover}
canvas#overlay{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none}
#overlayContainer{
  position:fixed;left:50%;top:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;z-index:9999;display:none;
}
#overlayContainer video,
#overlayContainer canvas{
  width:100%;height:100%;object-fit:contain;background:transparent;
}
#startBtn{
  position:fixed;left:50%;top:50%;
  transform:translate(-50%,-50%);
  padding:14px 18px;font-size:18px;
  border:none;border-radius:10px;
  background:#ff4fa8;color:#fff;z-index:10000;
}
#bigMatch{
  position:fixed;left:10px;top:10px;
  z-index:10000;font-size:14px;
  background:rgba(0,0,0,0.5);
  padding:6px 8px;border-radius:6px;
}

/* Camera button */
.cameraBar{
  position:fixed;left:50%;bottom:22px;
  transform:translateX(-50%);
  z-index:12000;
}
.shutterBtn{
  width:84px;height:84px;border-radius:50%;
  background:#ff4fa8;border:6px solid rgba(255,255,255,.2);
  display:flex;align-items:center;justify-content:center;
}
.shutterInner{
  width:60px;height:60px;border-radius:50%;
  background:#fff;
}
.recording .shutterInner{
  background:#000;border-radius:12px;
}
</style>
</head>

<body>

<div id="videoWrapper">
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>
</div>

<div id="overlayContainer"></div>

<button id="startBtn">Activar AR</button>
<div id="bigMatch">Match: --</div>

<div class="cameraBar">
  <div id="shutter" class="shutterBtn">
    <div class="shutterInner"></div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const TARGET_URL = './skeleton.png';
const WEBM_URL   = './skeleton.webm';

const PNG_PATH  = './assets/anim_png/';
const PNG_COUNT = 8;
const PNG_FPS   = 8;

const REQUIRED_MATCHES = 10;
const REQUIRED_INLIERS = 8;

const MIN_OVERLAY_SCALE = 0.35;
const MAX_OVERLAY_SCALE = 0.85;
/* ========================================= */

const cam = document.getElementById('cam');
const overlayContainer = document.getElementById('overlayContainer');
const startBtn = document.getElementById('startBtn');
const bigMatch = document.getElementById('bigMatch');
const shutter = document.getElementById('shutter');

let worker=null, streaming=false;
let procW=1, procH=1;
let offscreen;
let frameCounter=0;
let RES_SCALE=0.7, FRAME_SKIP=2;

let mediaRecorder=null, recordedChunks=[];
let isRecording=false, holdTimer=null;

/* ---------- iOS detection ---------- */
function isIOS(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}
const IS_IOS = isIOS();

/* ---------- PNG sequence (RAF-safe) ---------- */
let pngFrames=[], pngIdx=0;
let fxCanvas=null, fxCtx=null;
let pngPlaying=false;
let lastTS=0, acc=0;
const FRAME_TIME=1000/PNG_FPS;

function preloadPNGs(){
  if(pngFrames.length) return;
  for(let i=1;i<=PNG_COUNT;i++){
    const img=new Image();
    img.src=PNG_PATH+`frame_${String(i).padStart(4,'0')}.png`;
    pngFrames.push(img);
  }
}
function pngLoop(ts){
  if(!pngPlaying) return;
  if(!lastTS) lastTS=ts;
  acc+=ts-lastTS;
  lastTS=ts;
  if(acc>=FRAME_TIME){
    acc-=FRAME_TIME;
    pngIdx=(pngIdx+1)%PNG_COUNT;
  }
  fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
  const img=pngFrames[pngIdx];
  if(img && img.complete){
    fxCtx.drawImage(img,0,0,fxCanvas.width,fxCanvas.height);
  }
  requestAnimationFrame(pngLoop);
}
function startPNG(size){
  if(!fxCanvas){
    fxCanvas=document.createElement('canvas');
    fxCtx=fxCanvas.getContext('2d');
    overlayContainer.innerHTML='';
    overlayContainer.appendChild(fxCanvas);
  }
  fxCanvas.width=size;
  fxCanvas.height=size;
  pngPlaying=true;lastTS=0;acc=0;
  requestAnimationFrame(pngLoop);
}
function stopPNG(){ pngPlaying=false; pngIdx=0; }

/* ---------- Overlay ---------- */
function showOverlay(size){
  overlayContainer.style.display='block';
  overlayContainer.style.width=size+'px';
  overlayContainer.style.height=size+'px';
  preloadPNGs();
  startPNG(size);
}
function hideOverlay(){
  overlayContainer.style.display='none';
  stopPNG();
}

/* ---------- Camera ---------- */
startBtn.onclick=async()=>{
  startBtn.style.display='none';
  const stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:'environment'},audio:true
  });
  cam.srcObject=stream;
  await cam.play();
  streaming=true;
  resize();
  initWorker();
  loop();
};
function resize(){
  procW=Math.floor(cam.videoWidth*RES_SCALE);
  procH=Math.floor(cam.videoHeight*RES_SCALE);
  offscreen=new OffscreenCanvas(procW,procH);
}

/* ---------- Worker ---------- */
function initWorker(){
  worker=new Worker('worker.js');
  worker.onmessage=(e)=>{
    const d=e.data;
    if(d.type==='ready'){
      worker.postMessage({type:'init',targetUrl:TARGET_URL,procW,procH});
    }
    if(d.type==='result'){
      bigMatch.textContent=`Matches:${d.matches} Inliers:${d.inliers}`;
      if(d.matches<REQUIRED_MATCHES||d.inliers<REQUIRED_INLIERS||!d.corners){
        hideOverlay();return;
      }
      const dx=d.corners[2]-d.corners[0];
      const dy=d.corners[3]-d.corners[1];
      const area=Math.abs(dx*dy);
      const norm=Math.min(1,area/(procW*procH));
      const scale=MIN_OVERLAY_SCALE+(MAX_OVERLAY_SCALE-MIN_OVERLAY_SCALE)*norm;
      showOverlay(Math.min(innerWidth,innerHeight)*scale);
    }
  };
}
function sendFrame(){
  const ctx=offscreen.getContext('2d');
  ctx.drawImage(cam,0,0,procW,procH);
  const bmp=offscreen.transferToImageBitmap();
  worker.postMessage({type:'frame',bitmap:bmp},[bmp]);
}
function loop(){
  if(!streaming) return;
  frameCounter=(frameCounter+1)%FRAME_SKIP;
  if(frameCounter===0) sendFrame();
  requestAnimationFrame(loop);
}

/* ---------- FOTO / VIDEO ---------- */
shutter.onmousedown=()=>{
  holdTimer=setTimeout(startRecording,400);
};
shutter.onmouseup=()=>{
  if(holdTimer){
    clearTimeout(holdTimer);
    takePhoto();
  }
  if(isRecording) stopRecording();
};

function takePhoto(){
  const c=document.createElement('canvas');
  c.width=cam.videoWidth;
  c.height=cam.videoHeight;
  const cx=c.getContext('2d');
  cx.drawImage(cam,0,0,c.width,c.height);
  if(fxCanvas){
    cx.drawImage(fxCanvas,
      (c.width-fxCanvas.width)/2,
      (c.height-fxCanvas.height)/2
    );
  }
  c.toBlob(b=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    a.download=`foto_ar_${Date.now()}.png`;
    a.click();
  });
}

function startRecording(){
  isRecording=true;
  shutter.classList.add('recording');

  const rc=document.createElement('canvas');
  rc.width=cam.videoWidth;
  rc.height=cam.videoHeight;
  const rctx=rc.getContext('2d');

  function draw(){
    rctx.drawImage(cam,0,0,rc.width,rc.height);
    if(fxCanvas){
      rctx.drawImage(fxCanvas,
        (rc.width-fxCanvas.width)/2,
        (rc.height-fxCanvas.height)/2
      );
    }
    if(isRecording) requestAnimationFrame(draw);
  }
  draw();

  const stream=rc.captureStream(30);
  mediaRecorder=new MediaRecorder(stream);
  recordedChunks=[];
  mediaRecorder.ondataavailable=e=>recordedChunks.push(e.data);
  mediaRecorder.onstop=()=>{
    const blob=new Blob(recordedChunks,{type:mediaRecorder.mimeType});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`video_ar_${Date.now()}.mp4`;
    a.click();
  };
  mediaRecorder.start();
}

function stopRecording(){
  isRecording=false;
  shutter.classList.remove('recording');
  mediaRecorder.stop();
}
</script>

</body>
</html>
