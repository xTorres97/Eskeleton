<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>AR Camiseta</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />

<style>
html,body{margin:0;height:100%;background:#000;color:#fff;font-family:Arial}
#videoWrapper{position:fixed;inset:0;overflow:hidden}
#cam{width:100%;height:100%;object-fit:cover}
canvas#overlay{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none}
#overlayContainer{
  position:fixed;
  left:50%;top:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
  z-index:9999;
  display:none;
}
#overlayContainer video,
#overlayContainer canvas{
  width:100%;
  height:100%;
  object-fit:contain;
  background:transparent;
}
#startBtn{
  position:fixed;left:50%;top:50%;
  transform:translate(-50%,-50%);
  padding:14px 18px;
  font-size:18px;
  border:none;border-radius:10px;
  background:#ff4fa8;color:#fff;
  z-index:10000;
}
#bigMatch{
  position:fixed;left:10px;top:10px;
  z-index:10000;font-size:14px;
  background:rgba(0,0,0,0.5);
  padding:6px 8px;border-radius:6px;
}
</style>
</head>

<body>

<div id="videoWrapper">
  <video id="cam" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>
</div>

<div id="overlayContainer"></div>

<button id="startBtn">Activar AR</button>

<script>
/* ================= CONFIG ================= */
const TARGET_URL = './skeleton.png';
const WEBM_URL   = './skeleton.webm';

const PNG_PATH  = './assets/anim_png/';
const PNG_COUNT = 8;
const PNG_FPS   = 8;

const REQUIRED_MATCHES = 10;
const REQUIRED_INLIERS = 8;

const MIN_OVERLAY_SCALE = 0.35;
const MAX_OVERLAY_SCALE = 0.85;
/* ========================================= */

const cam = document.getElementById('cam');
const overlayContainer = document.getElementById('overlayContainer');
const startBtn = document.getElementById('startBtn');
const bigMatch = document.getElementById('bigMatch');

let worker=null, streaming=false;
let procW=1, procH=1;
let offscreen;
let frameCounter=0;
let RES_SCALE=0.7, FRAME_SKIP=2;

let currentPNGFrameIndex = 0;

/* ---------- iOS detection ---------- */
function isIOS(){
  return /iPad|iPhone|iPod/.test(navigator.userAgent) ||
    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
}
const IS_IOS = isIOS();

/* ---------- ANDROID: WebM ---------- */
const overlayVideoMarkup = () => `
<video id="fxVideo" autoplay loop muted playsinline>
  <source src="${WEBM_URL}" type="video/webm">
</video>`;

/* ---------- iOS: PNG sequence (RAF SAFE) ---------- */
let pngFrames=[], pngIdx=0;
let fxCanvas=null, fxCtx=null;
let pngPlaying=false;
let lastTS=0, acc=0;
const PNG_FRAME_TIME = 1000 / PNG_FPS;

function preloadPNGs(){
  if(pngFrames.length) return;
  for(let i=1;i<=PNG_COUNT;i++){
    const img=new Image();
    img.src = PNG_PATH + `frame_${String(i).padStart(4,'0')}.png`;
    pngFrames.push(img);
  }
}

function pngLoop(ts){
  if(!pngPlaying) return;
  if(!lastTS) lastTS = ts;
  const delta = ts - lastTS;
  lastTS = ts;
  acc += delta;

  if(acc >= PNG_FRAME_TIME){
    acc -= PNG_FRAME_TIME;
    pngIdx = (pngIdx + 1) % PNG_COUNT;
    currentPNGFrameIndex = pngIdx;
  }

  drawPNGFrame();
  requestAnimationFrame(pngLoop);
}

function drawPNGFrame(){
  if(!fxCtx) return;
  fxCtx.clearRect(0,0,fxCanvas.width,fxCanvas.height);
  const img = pngFrames[pngIdx];
  if(img && img.complete){
    fxCtx.drawImage(img,0,0,fxCanvas.width,fxCanvas.height);
  }
}

function startPNG(size){
  if(!fxCanvas){
    fxCanvas = document.createElement('canvas');
    fxCtx = fxCanvas.getContext('2d');
    overlayContainer.innerHTML='';
    overlayContainer.appendChild(fxCanvas);
  }
  fxCanvas.width = size;
  fxCanvas.height = size;

  if(pngPlaying) return;
  pngPlaying = true;
  lastTS = 0; acc = 0;
  requestAnimationFrame(pngLoop);
}

function stopPNG(){
  pngPlaying = false;
  pngIdx = 0;
  acc = 0;
}

/* ---------- overlay ---------- */
function showOverlay(sizePx){
  overlayContainer.style.display='block';
  overlayContainer.style.width=sizePx+'px';
  overlayContainer.style.height=sizePx+'px';

  if(IS_IOS){
    preloadPNGs();
    startPNG(sizePx);
  }else{
    if(!document.getElementById('fxVideo')){
      overlayContainer.innerHTML=overlayVideoMarkup();
    }
    try{document.getElementById('fxVideo').play();}catch(e){}
  }
}

function hideOverlay(){
  overlayContainer.style.display='none';
  stopPNG();
}

/* ---------- camera ---------- */
startBtn.onclick=async()=>{
  startBtn.style.display='none';
  const stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:'environment'},audio:true
  });
  cam.srcObject=stream;
  await cam.play();
  streaming=true;
  resize();
  initWorker();
  loop();
};

function resize(){
  procW=Math.floor(cam.videoWidth*RES_SCALE);
  procH=Math.floor(cam.videoHeight*RES_SCALE);
  offscreen=new OffscreenCanvas(procW,procH);
}

/* ---------- worker ---------- */
function initWorker(){
  worker=new Worker('worker.js');
  worker.onmessage=(e)=>{
    const d=e.data;
    if(d.type==='ready'){
      worker.postMessage({type:'init',targetUrl:TARGET_URL,procW,procH});
    }
    if(d.type==='result'){
      if(d.matches<REQUIRED_MATCHES || d.inliers<REQUIRED_INLIERS || !d.corners){
        hideOverlay(); return;
      }

      const dx1=d.corners[2]-d.corners[0];
      const dy1=d.corners[3]-d.corners[1];
      const dx2=d.corners[6]-d.corners[0];
      const dy2=d.corners[7]-d.corners[1];
      const area=Math.abs(dx1*dy2-dy1*dx2);
      const norm=Math.min(1,Math.max(0,area/(procW*procH)));
      const scale=MIN_OVERLAY_SCALE+(MAX_OVERLAY_SCALE-MIN_OVERLAY_SCALE)*norm;
      const sizePx=Math.round(Math.min(innerWidth,innerHeight)*scale);

      showOverlay(sizePx);
    }
  };
}

function sendFrame(){
  const ctx=offscreen.getContext('2d');
  ctx.drawImage(cam,0,0,procW,procH);
  const bmp=offscreen.transferToImageBitmap();
  worker.postMessage({type:'frame',bitmap:bmp},[bmp]);
}

function loop(){
  if(!streaming) return;
  frameCounter=(frameCounter+1)%FRAME_SKIP;
  if(frameCounter===0) sendFrame();
  requestAnimationFrame(loop);
}
</script>

</body>
</html>
